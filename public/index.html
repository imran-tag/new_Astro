<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech Interventions Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #dbeafe;
            --background-color: #f0f4ff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-color: #ef4444;
        }
        
        .status-received { @apply bg-yellow-100 text-yellow-800; }
        .status-assigned { @apply bg-blue-100 text-blue-800; }
        .status-in-progress { @apply bg-orange-100 text-orange-800; }
        .status-completed { @apply bg-green-100 text-green-800; }
        .status-billed { @apply bg-gray-100 text-gray-800; }
        .status-paid { @apply bg-green-200 text-green-900; }
        
        .urgent-row {
            @apply border-l-4 border-red-500 bg-red-50;
        }
        
        .stat-card {
            @apply bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            @apply animate-pulse bg-gray-200 rounded;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">TI</span>
                        </div>
                        <h1 class="text-xl font-bold text-gray-900">Tech Interventions</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="connection-status" class="text-sm text-gray-500">Connecting...</span>
                    <div class="w-8 h-8 bg-gray-300 rounded-full"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Dashboard Title -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
            <p class="text-gray-600">Track and manage technical interventions</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="stat-card" onclick="filterByStatus('received')">
                <div class="text-sm font-medium text-yellow-600">Received</div>
                <div id="stat-received" class="text-2xl font-bold text-gray-900">-</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('assigned')">
                <div class="text-sm font-medium text-blue-600">Assigned</div>
                <div id="stat-assigned" class="text-2xl font-bold text-gray-900">-</div>
            </div>
            <div class="stat-card bg-blue-50 ring-2 ring-blue-500" onclick="filterByStatus('in-progress')">
                <div class="text-sm font-medium text-orange-600">In Progress</div>
                <div id="stat-inProgress" class="text-2xl font-bold text-gray-900">-</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('completed')">
                <div class="text-sm font-medium text-green-600">Completed</div>
                <div id="stat-completed" class="text-2xl font-bold text-gray-900">-</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('billed')">
                <div class="text-sm font-medium text-gray-600">Billed</div>
                <div id="stat-billed" class="text-2xl font-bold text-gray-900">-</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('paid')">
                <div class="text-sm font-medium text-green-700">Paid</div>
                <div id="stat-paid" class="text-2xl font-bold text-gray-900">-</div>
            </div>
        </div>

        <!-- Urgent Interventions -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-900">Urgent: Action Required (48h)</h2>
                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">View All</button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time Left</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned</th>
                            </tr>
                        </thead>
                        <tbody id="urgent-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading urgent interventions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Interventions -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-900">Recent Interventions</h2>
                <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">View All</button>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned</th>
                            </tr>
                        </thead>
                        <tbody id="recent-table" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading recent interventions...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Check connection and load data
        async function checkConnection() {
            try {
                const response = await fetch('/nodetest/api/test-db');
                const result = await response.json();
                
                const statusEl = document.getElementById('connection-status');
                if (result.success) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'text-sm text-green-600';
                    loadDashboardData();
                } else {
                    statusEl.textContent = 'Connection Failed';
                    statusEl.className = 'text-sm text-red-600';
                }
            } catch (error) {
                const statusEl = document.getElementById('connection-status');
                statusEl.textContent = 'Offline';
                statusEl.className = 'text-sm text-red-600';
            }
        }

        // Load dashboard statistics
        async function loadStats() {
            try {
                const response = await fetch('/nodetest/api/stats');
                const stats = await response.json();
                
                document.getElementById('stat-received').textContent = stats.received || 0;
                document.getElementById('stat-assigned').textContent = stats.assigned || 0;
                document.getElementById('stat-inProgress').textContent = stats.inProgress || 0;
                document.getElementById('stat-completed').textContent = stats.completed || 0;
                document.getElementById('stat-billed').textContent = stats.billed || 0;
                document.getElementById('stat-paid').textContent = stats.paid || 0;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load urgent interventions
        async function loadUrgent() {
            try {
                const response = await fetch('/nodetest/api/urgent');
                const urgent = await response.json();
                
                const tbody = document.getElementById('urgent-table');
                
                if (urgent.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No urgent interventions</td></tr>';
                    return;
                }
                
                tbody.innerHTML = urgent.map(item => `
                    <tr class="${item.hours_remaining < 24 ? 'urgent-row' : 'hover:bg-gray-50'}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">${item.intervention_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.client_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.service_type}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${item.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full status-${item.status.toLowerCase().replace(' ', '-')}">
                                ${item.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${item.hours_remaining < 24 ? 'text-red-600 font-bold' : 'text-gray-900'}">
                            ${item.hours_remaining > 0 ? Math.round(item.hours_remaining) + 'h' : 'Overdue'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.assigned_to || 'Unassigned'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load urgent interventions:', error);
                document.getElementById('urgent-table').innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Failed to load data</td></tr>';
            }
        }

        // Load recent interventions
        async function loadRecent() {
            try {
                const response = await fetch('/nodetest/api/recent');
                const recent = await response.json();
                
                const tbody = document.getElementById('recent-table');
                
                if (recent.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No recent interventions</td></tr>';
                    return;
                }
                
                tbody.innerHTML = recent.map(item => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">${item.intervention_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.client_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.service_type}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${item.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full status-${item.status.toLowerCase().replace(' ', '-')}">
                                ${item.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(item.due_date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.assigned_to || 'Unassigned'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load recent interventions:', error);
                document.getElementById('recent-table').innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Failed to load data</td></tr>';
            }
        }

        // Load all dashboard data
        function loadDashboardData() {
            loadStats();
            loadUrgent();
            loadRecent();
        }

        // Filter by status (placeholder function)
        function filterByStatus(status) {
            console.log('Filter by status:', status);
            // This would navigate to a filtered view
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            
            // Refresh data every 30 seconds
            setInterval(loadDashboardData, 30000);
        });
    </script>
</body>
</html>